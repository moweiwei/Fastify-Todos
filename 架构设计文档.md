å½“ç„¶å¯ä»¥ï¼ä¸‹é¢æ˜¯ **åŸºäºä½ æä¾›çš„å…¨éƒ¨å†…å®¹æ•´ç†å‡ºçš„å®Œæ•´ Markdown ç‰ˆåç«¯æ¶æ„è®¾è®¡æ–‡æ¡£**ï¼Œç»„ç»‡æ¸…æ™°ï¼Œå¯ç›´æ¥ä½œä¸º README.md ä½¿ç”¨ã€‚

---

# â­ åç«¯æ¶æ„è®¾è®¡æ–‡æ¡£

**åŸºäº NestJS + Fastify + Prisma + MySQL æ„å»ºçš„åç«¯æœåŠ¡**
**å‰ç«¯æ­é…ï¼šArt Design Proï¼ˆVue3 + TS + Viteï¼‰**

---

# ğŸ“Œ æ¦‚è¿°

æœ¬é¡¹ç›®æ—¨åœ¨ä¸º Art Design Pro åå°ç®¡ç†ç³»ç»Ÿæä¾›
**é«˜æ€§èƒ½ã€å¯æ‰©å±•ã€æ¨¡å—åŒ–ã€å·¥ç¨‹åŒ–** çš„åç«¯æœåŠ¡ã€‚

ç›®æ ‡åŒ…æ‹¬ï¼š

* å®Œæ•´æ”¯æ’‘åå°å…¸å‹åŠŸèƒ½ï¼ˆç”¨æˆ·ã€æƒé™ã€èœå•ã€æ—¥å¿—ã€æ–‡ä»¶ä¸Šä¼ ã€ç³»ç»Ÿè®¾ç½®ç­‰ï¼‰
* æä¾› RESTful APIï¼Œæ¸…æ™°è§„èŒƒ
* æ¶æ„æ˜“æ‰©å±•ï¼Œæ–¹ä¾¿äºŒæ¬¡å¼€å‘ï¼ˆä¸šåŠ¡æ¨¡å—æ‰©å±•å¦‚è®¢å•ã€å†…å®¹ã€äº§å“ç­‰ï¼‰
* é…ç½®å®Œå–„çš„æ—¥å¿—ã€é”™è¯¯å¤„ç†ã€æƒé™ç³»ç»Ÿ

---

# ğŸ§± 1. æŠ€æœ¯æ ˆä¸åŸºç¡€èƒ½åŠ›

| æŠ€æœ¯                 | è¯´æ˜                           |
| ------------------ | ---------------------------- |
| **NestJS**         | åç«¯æ¡†æ¶ï¼Œæ¨¡å—åŒ–ã€ä¾èµ–æ³¨å…¥ã€AOP            |
| **FastifyAdapter** | Nest çš„é«˜æ€§èƒ½åº•å±‚ HTTP é©±åŠ¨          |
| **Prisma ORM**     | ç±»å‹å®‰å…¨ã€è‡ªåŠ¨ç”Ÿæˆ SQLï¼Œé«˜æ•ˆç‡å¼€å‘          |
| **MySQL**          | ä¸»å…³ç³»å‹æ•°æ®åº“                      |
| **Redisï¼ˆå¯é€‰ï¼‰**      | Token ç¼“å­˜ã€å¤šç«¯ç™»å½•ã€éªŒè¯ç             |
| **Swagger**        | è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£                  |
| **JWT**            | ç™»å½•è®¤è¯ï¼ˆAccess + Refresh Tokenï¼‰ |
| **RBAC**           | è§’è‰² + èœå• + æŒ‰é’®çº§æƒé™æ§åˆ¶            |
| **nodemon**        | å¼€å‘æ¨¡å¼çƒ­é‡è½½                      |
| **pino æˆ– winston** | å¼ºå¤§å¯æ‰©å±•çš„æ—¥å¿—ç³»ç»Ÿ                   |

---

# ğŸ§© 2. æ¶æ„é£æ ¼

æ•´ä½“æ¶æ„é‡‡ç”¨ï¼š

* **æ¨¡å—åŒ–ï¼ˆModularï¼‰**
* **åˆ†å±‚æ¶æ„ï¼ˆLayered Architectureï¼‰**
* **RESTful API**
* **BFFï¼ˆBackend For Frontendï¼‰æ¨¡å¼**

NestJS ä¸‰å±‚ç»“æ„ï¼š

```
Controller â†’ Service â†’ Repository(Prisma)
```

---

# ğŸ“ 3. é¡¹ç›®ç›®å½•ç»“æ„

```
src
â”œâ”€ main.ts                # Fastify å¯åŠ¨å…¥å£
â”œâ”€ app.module.ts
â”‚
â”œâ”€ config/                # é…ç½®æ¨¡å—
â”‚  â”œâ”€ app.config.ts
â”‚  â”œâ”€ cors.config.ts
â”‚  â”œâ”€ database.config.ts
â”‚  â””â”€ jwt.config.ts
â”‚
â”œâ”€ common/
â”‚  â”œâ”€ interceptors/       # æ—¥å¿—ã€å“åº”åŒ…è£…
â”‚  â”œâ”€ filters/            # å…¨å±€å¼‚å¸¸å¤„ç†å™¨
â”‚  â”œâ”€ guards/             # æƒé™å®ˆå«ï¼ˆRBACï¼‰
â”‚  â”œâ”€ decorators/         # è‡ªå®šä¹‰è£…é¥°å™¨
â”‚  â”œâ”€ pipes/              # å‚æ•°æ ¡éªŒ
â”‚  â””â”€ utils/              # å…¬å…±å·¥å…·
â”‚
â”œâ”€ infra/
â”‚  â”œâ”€ prisma.service.ts   # ORM å®¢æˆ·ç«¯
â”‚  â””â”€ redis.service.ts    # Redis å®¢æˆ·ç«¯
â”‚
â”œâ”€ modules/
â”‚  â”œâ”€ auth/               # ç™»å½• / è®¤è¯ / æƒé™
â”‚  â”œâ”€ user/               # ç”¨æˆ·ç®¡ç†
â”‚  â”œâ”€ role/               # è§’è‰²ç®¡ç†
â”‚  â”œâ”€ menu/               # èœå•ç®¡ç†
â”‚  â”œâ”€ permission/         # æƒé™ç‚¹
â”‚  â”œâ”€ dept/               # éƒ¨é—¨ç»„ç»‡
â”‚  â”œâ”€ dict/               # å­—å…¸ç®¡ç†
â”‚  â”œâ”€ file/               # æ–‡ä»¶ä¸Šä¼ 
â”‚  â”œâ”€ system/             # ç³»ç»Ÿé…ç½®
â”‚  â”œâ”€ log/
â”‚  â”‚  â”œâ”€ login/           # ç™»å½•æ—¥å¿—
â”‚  â”‚  â””â”€ operation/       # æ“ä½œæ—¥å¿—
â”‚  â”œâ”€ monitor/            # æœåŠ¡ç›‘æ§ï¼ˆå¯é€‰ï¼‰
â”‚  â””â”€ demo/               # ç¤ºä¾‹ CRUD
â”‚
â””â”€ prisma/
   â”œâ”€ schema.prisma       # å…¨éƒ¨æ•°æ®æ¨¡å‹
   â””â”€ migrations/         # æ•°æ®åº“å˜æ›´
```

---

# ğŸ—„ï¸ 4. æ•°æ®åº“æ¨¡å‹ï¼ˆPrisma + MySQLï¼‰

æ”¯æŒ RBAC æƒé™æ¨¡å‹ï¼Œä¸»è¦è¡¨å¦‚ä¸‹ï¼š

## 4.1 ç”¨æˆ·è¡¨ï¼ˆUserï¼‰

```prisma
model User {
  id        Int       @id @default(autoincrement())
  username  String    @unique
  password  String
  nickname  String?
  avatar    String?
  email     String?
  phone     String?
  status    Boolean   @default(true)
  roles     UserRole[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}
```

## 4.2 è§’è‰²è¡¨ï¼ˆRoleï¼‰

```prisma
model Role {
  id        Int        @id @default(autoincrement())
  name      String
  code      String     @unique
  status    Boolean    @default(true)
  menus     RoleMenu[]
  users     UserRole[]
}
```

## 4.3 ç”¨æˆ·è§’è‰²å¤šå¯¹å¤šå…³ç³»

```prisma
model UserRole {
  userId Int
  roleId Int
  user   User @relation(fields: [userId], references: [id])
  role   Role @relation(fields: [roleId], references: [id])
  @@id([userId, roleId])
}
```

## 4.4 èœå•è¡¨ï¼ˆç›®å½•/èœå•/æŒ‰é’®ï¼‰

```prisma
model Menu {
  id        Int      @id @default(autoincrement())
  parentId  Int?
  name      String
  path      String?
  component String?
  type      Int       // 0:ç›®å½• 1:èœå• 2:æŒ‰é’®
  icon      String?
  order     Int       @default(0)
  hidden    Boolean   @default(false)
  roles     RoleMenu[]
}
```

---

# ğŸ” 5. è®¤è¯ & æƒé™ç³»ç»Ÿï¼ˆAuth + RBACï¼‰

## 5.1 ç™»å½•æµç¨‹

1. ç”¨æˆ·æäº¤è´¦å·/å¯†ç 
2. æ£€æŸ¥è´¦å·çŠ¶æ€
3. æ¯”å¯¹å¯†ç 
4. ç”Ÿæˆ Access Tokenï¼ˆ15minï¼‰
5. ç”Ÿæˆ Refresh Tokenï¼ˆ7 å¤©ï¼‰
6. è®°å½•ç™»å½•æ—¥å¿—
7. è¿”å›ï¼š

   * token
   * ç”¨æˆ·ä¿¡æ¯
   * å¯è®¿é—®èœå•
   * æŒ‰é’®æƒé™ç‚¹åˆ—è¡¨

---

## 5.2 API åˆ—è¡¨

| Method | Path              | æè¿°       |
| ------ | ----------------- | -------- |
| POST   | /auth/login       | ç™»å½•       |
| POST   | /auth/refresh     | åˆ·æ–°Token  |
| GET    | /auth/profile     | è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ |
| GET    | /auth/permissions | è·å–æŒ‰é’®æƒé™ç‚¹  |

---

## 5.3 æƒé™å®ˆå«

ä½¿ç”¨ NestJS çš„ Guards ä½“ç³»ï¼š

```ts
@UseGuards(JwtAuthGuard, PermissionGuard)
```

PermissionGuard ä¼šæ ¹æ®ç”¨æˆ·è§’è‰² â†’ èœå• â†’ æŒ‰é’®çº§æƒé™è¿›è¡ŒéªŒè¯ã€‚

---

# ğŸ“š 6. RESTful API è§„èŒƒ

æ‰€æœ‰èµ„æºéµå¾ª RESTful è®¾è®¡ï¼š

| æ“ä½œ   | Method | è·¯ç”±         |
| ---- | ------ | ---------- |
| æŸ¥è¯¢åˆ—è¡¨ | GET    | /users     |
| æŸ¥è¯¢è¯¦æƒ… | GET    | /users/:id |
| åˆ›å»º   | POST   | /users     |
| ä¿®æ”¹   | PUT    | /users/:id |
| åˆ é™¤   | DELETE | /users/:id |

ç¤ºä¾‹å“åº”ï¼š

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [],
    "total": 100
  }
}
```

---

# ğŸŒ 7. CORS æ”¯æŒ

```ts
app.enableCors({
  origin: "*",
  credentials: true
})
```

å¯æ”¹ä¸ºï¼š

```ts
origin: ["https://admin.xxx.com"]
```

---

# ğŸ”¥ 8. çƒ­é‡è½½ï¼ˆnodemonï¼‰

package.json:

```json
{
  "scripts": {
    "start:dev": "nodemon --watch src -e ts --exec ts-node-dev src/main.ts"
  }
}
```

æ”¯æŒï¼š

* ä¿®æ”¹ä»£ç è‡ªåŠ¨çƒ­é‡è½½
* Prisma schema è‡ªåŠ¨ reload

---

# ğŸ“ 9. æ—¥å¿—ç³»ç»Ÿ

é‡‡ç”¨ pino / winston è®°å½•ï¼š

* è¯·æ±‚æ—¥å¿—
* é”™è¯¯æ—¥å¿—
* æ“ä½œæ—¥å¿—ï¼ˆæ•°æ®åº“ï¼‰
* ç™»å½•æ—¥å¿—ï¼ˆæ•°æ®åº“ï¼‰

ç¤ºä¾‹ LoggingInterceptorï¼š

```ts
@Injectable()
export class LoggingInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler) {
    const request = context.switchToHttp().getRequest();
    const now = Date.now();

    return next.handle().pipe(
      tap(() => {
        console.log(
          `[${request.method}] ${request.url} - ${Date.now() - now}ms`
        );
      })
    );
  }
}
```

---

# â— 10. å…¨å±€é”™è¯¯å¤„ç†

å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨ï¼š

```ts
@Catch(HttpException)
export class HttpExceptionFilter implements ExceptionFilter {
  catch(exception: HttpException, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse();
    const request = ctx.getRequest();

    response.status(exception.getStatus()).send({
      code: exception.getStatus(),
      message: exception.message,
      timestamp: new Date().toISOString(),
      path: request.url
    });
  }
}
```

---

# ğŸ§ª 11. ä¸å‰ç«¯è”è°ƒå»ºè®®

* åç«¯ç»Ÿä¸€ prefixï¼š`/api`
* ç»Ÿä¸€å“åº”æ ¼å¼ï¼ˆåŒ…å« code/message/dataï¼‰
* å¯ç”¨ CORS
* token æ”¾åœ¨ Authorization: Bearer xxx
* èœå•ç”±åç«¯è¿”å›ï¼Œå‰ç«¯åŠ¨æ€è·¯ç”±åŠ è½½

---

# ğŸš€ 12. éƒ¨ç½²æ¶æ„

æ¨èæ¶æ„ï¼š

```
[Frontend]
  Art Design Pro (é™æ€èµ„æºéƒ¨ç½²åˆ° Nginx)

[Backend]
  NestJS + Fastify (PM2 or Docker)

[Database]
  MySQL

[Cache]
  Redis
```

ä¹Ÿæ”¯æŒæ‰©å±•ï¼š

* å¾®æœåŠ¡ï¼ˆç”¨æˆ·ä¸­å¿ƒã€æ—¥å¿—ä¸­å¿ƒï¼‰
* é˜Ÿåˆ—ç³»ç»Ÿï¼ˆBullMQï¼‰
* WebSocket å®æ—¶æ¨é€

---

# ğŸ“¦ 13. Dockerfile + docker-compose.yml

å¦‚æœä½ æƒ³è¦ï¼Œæˆ‘å¯ç»§ç»­ä¸ºä½ ç”Ÿæˆï¼š

### âœ” Dockerfile

### âœ” docker-compose.ymlï¼ˆå« MySQL + Prisma + Redis + Backendï¼‰

åªéœ€å‘Šè¯‰æˆ‘ï¼š

**â€œç”Ÿæˆ Dockerfile å’Œ Composeâ€**

---

# ğŸ‰ æ–‡æ¡£æ•´ç†å®Œæ¯•ï¼

å¦‚æœä½ éœ€è¦ï¼š
âœ” ç”Ÿæˆä¸€ä¸ªå¯ç›´æ¥è¿è¡Œçš„ NestJS + Prisma åç«¯è„šæ‰‹æ¶
âœ” ç”Ÿæˆå…¨éƒ¨æ¨¡å—ä»£ç æ¡†æ¶ï¼ˆAuth/User/Menu/Role/Log/Dictï¼‰
âœ” ç”Ÿæˆå®Œæ•´ Prisma schema + åˆå§‹æ•°æ® Seeder
âœ” ç”Ÿæˆ PM2 é…ç½® / Docker éƒ¨ç½²è„šæœ¬

éšæ—¶å‘Šè¯‰æˆ‘ï¼Œæˆ‘å¯ä»¥ä¸€é”®ç”Ÿæˆå®Œæ•´å·¥ç¨‹ã€‚
